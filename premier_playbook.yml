---
- name: "PLAY 1 - Conformité manager"
  hosts: manager
 
  tasks:
    - name: "Creation d'une paire de clés ssh sur manager"
      community.crypto.openssh_keypair:
        state: present
        type: ed25519
        path: id_ansible
        comment: manager@formation

- name: "PLAY 2 - Bootstrap python"
  hosts: linux
  gather_facts: false
  become: true

  tasks:
    - name: "Mode raw pour test interpreteur python"
      raw: 'bash -c "test -f /usr/bin/python3"'
      ignore_errors: true

    - name: "Tentative d'installation python3 en raw"
      raw: 'bash -c "(apt-get update && apt-get install -y python3) || (yum install -y python3)"'
    

- name: "PLAY 2 - config playbook"
  # Target : à qui s'adresse se PLAY
  hosts: linux
  become: true

  vars:
    user: formation
    key_status: present

  # Déclation du block tasks pour appeler des modules
  tasks:
    - name: "Ajout utilisateur"
      user:
        name: "{{ user }}"
        state: present
        uid: 1002
        # Utilisation d'une variable du fichier d'inventaire 
        group: "{{ sudogrp }}"

    - name: "Creation d'un fichier"
      copy:
        dest: "/home/{{ user }}/fichier1"
        content: "Mon fichier généré par ansible"
        owner: "{{ user }}"
        group: "{{ user }}"
        mode: '0644'

    - name: "Ajout de la clé ed25519 du manager"
      ansible.posix.authorized_key:
        user: formation
        state: "{{ key_status }}"
        # lookup : cherche un objet de type file qui se nomme id_ansible.pub sur le manager
        key: "{{ lookup('file', 'id_ansible.pub') }}"